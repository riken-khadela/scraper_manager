{% extends "base.html" %}

{% block title %}Logs — {{ sub.name }}{% endblock %}

{% block breadcrumb %}
<a href="/scrapers/{{ main_scraper.id }}/">{{ main_scraper.name }}</a>
<span class="sep">/</span>
<a href="/scrapers/{{ main_scraper.id }}/sub/{{ sub.id }}/">{{ sub.name }}</a>
<span class="sep">/</span>
<span class="current">Logs</span>
{% endblock %}

{% block extra_head %}
<style>
.log-empty { text-align: center; color: var(--text-muted); padding: 40px; font-family: var(--font-mono); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Log Viewer — {{ sub.name }}</h1>
        <p class="page-subtitle">
            Log folder: <span class="font-mono" style="color:var(--text-secondary)">{{ sub.log_folder_path or 'Not configured' }}</span>
        </p>
    </div>
    <div class="page-actions">
        {% if is_running %}
        <span class="log-live-badge">
            <span class="log-live-dot"></span>LIVE
        </span>
        {% endif %}
        <a href="/scrapers/{{ main_scraper.id }}/sub/{{ sub.id }}/" class="btn btn--ghost btn--sm">← Back</a>
    </div>
</div>

{% if not sub.log_folder_path %}
<div class="card">
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
        <h3>No log folder configured</h3>
        <p>Set the log folder path in the scraper configuration</p>
        <div style="margin-top:16px">
            <a href="/scrapers/{{ main_scraper.id }}/sub/{{ sub.id }}/edit/" class="btn btn--primary">Configure</a>
        </div>
    </div>
</div>
{% elif not log_files %}
<div class="card">
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
        <h3>No log files found</h3>
        <p>No .log files in: {{ sub.log_folder_path }}</p>
    </div>
</div>
{% else %}
<div class="card">
    <div class="log-toolbar">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex:1">
            <label style="font-size:13px;color:var(--text-muted);white-space:nowrap">Log File:</label>
            <select id="log-file-select" class="form-control" style="max-width:300px">
                {% for lf in log_files %}
                <option value="{{ lf.path }}">{{ lf.name }} ({{ (lf.size / 1024) | round(1) }} KB)</option>
                {% endfor %}
            </select>

            <label style="font-size:13px;color:var(--text-muted);white-space:nowrap">Lines:</label>
            <select id="num-lines-select" class="form-control" style="max-width:100px">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
            </select>

            <button class="btn btn--ghost btn--sm" id="refresh-btn" onclick="loadLogs()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                Refresh
            </button>
        </div>

        <div style="display:flex;align-items:center;gap:10px">
            <label class="toggle-switch" style="gap:6px">
                <input type="checkbox" id="auto-refresh-toggle" checked onchange="toggleAutoRefresh()">
                <span class="toggle-track"></span>
                <span style="font-size:13px;color:var(--text-muted)">Auto-refresh</span>
            </label>
            <span id="refresh-countdown" style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono)"></span>
        </div>
    </div>

    <div class="log-container">
        <div class="log-lines" id="log-lines">
            <div class="log-empty">Loading logs...</div>
        </div>
    </div>

    <div class="card-footer" style="display:flex;align-items:center;justify-content:space-between">
        <span id="log-status" style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono)"></span>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)">
            <input type="checkbox" id="auto-scroll" checked>
            Auto-scroll to bottom
        </label>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
const IS_RUNNING = {{ 'true' if is_running else 'false' }};
let refreshInterval = null;
let refreshSeconds = IS_RUNNING ? 2 : 5;
let countdown = refreshSeconds;

function getLogLevel(line) {
    const lu = line.toUpperCase();
    if (lu.includes(' ERROR') || lu.includes('[ERROR]') || lu.startsWith('ERROR')) return 'error';
    if (lu.includes(' WARNING') || lu.includes('[WARNING]') || lu.includes(' WARN') || lu.startsWith('WARN')) return 'warning';
    if (lu.includes(' INFO') || lu.includes('[INFO]') || lu.startsWith('INFO')) return 'info';
    if (lu.includes(' DEBUG') || lu.includes('[DEBUG]') || lu.startsWith('DEBUG')) return 'debug';
    return 'default';
}

async function loadLogs() {
    const file = document.getElementById('log-file-select')?.value;
    const numLines = document.getElementById('num-lines-select')?.value || 100;
    if (!file) return;

    try {
        const res = await fetch(`/api/logs/?file_path=${encodeURIComponent(file)}&num_lines=${numLines}`);
        const data = await res.json();

        const container = document.getElementById('log-lines');
        if (!data.lines || data.lines.length === 0) {
            container.innerHTML = '<div class="log-empty">No log entries found</div>';
            return;
        }

        const html = data.lines.map((line, i) => {
            const level = getLogLevel(line);
            const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<div class="log-line log-line--${level}">
                <span class="log-line-num">${i + 1}</span>
                <span class="log-line-text">${escaped}</span>
            </div>`;
        }).join('');

        container.innerHTML = html;

        const autoScroll = document.getElementById('auto-scroll')?.checked;
        if (autoScroll) container.scrollTop = container.scrollHeight;

        const status = document.getElementById('log-status');
        if (status) status.textContent = `${data.lines.length} lines — refreshed ${new Date().toLocaleTimeString()}`;

    } catch(e) {
        document.getElementById('log-lines').innerHTML = `<div class="log-empty">Error loading logs: ${e.message}</div>`;
    }
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    countdown = refreshSeconds;

    refreshInterval = setInterval(() => {
        countdown--;
        const el = document.getElementById('refresh-countdown');
        if (el) el.textContent = `Next refresh in ${countdown}s`;

        if (countdown <= 0) {
            countdown = refreshSeconds;
            loadLogs();
        }
    }, 1000);
}

function stopAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = null;
    const el = document.getElementById('refresh-countdown');
    if (el) el.textContent = '';
}

function toggleAutoRefresh() {
    if (document.getElementById('auto-refresh-toggle').checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

// Initial load
loadLogs();
startAutoRefresh();

// Update interval when running vs idle
if (IS_RUNNING) {
    refreshSeconds = 2;
}

document.getElementById('log-file-select')?.addEventListener('change', () => {
    loadLogs();
    countdown = refreshSeconds;
});
</script>
{% endblock %}
